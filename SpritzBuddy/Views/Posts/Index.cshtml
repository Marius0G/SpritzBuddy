@model IEnumerable<SpritzBuddy.Models.Post>
@using System.Security.Claims

@{
    ViewData["Title"] = "Posts";
    bool showingAllPosts = ViewData["ShowingAllPosts"] as bool? ?? true;
}

<h1>@(showingAllPosts ? "All Posts" : "My Posts")</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="mb-3">
    <a asp-action="Create" class="btn btn-primary">Create New Post</a>
    @if (showingAllPosts)
    {
        <a asp-action="MyPosts" class="btn btn-secondary">View My Posts</a>
    }
    else
    {
        <a asp-action="Index" class="btn btn-secondary">View All Posts</a>
    }
    @if (User.Identity?.IsAuthenticated == true)
    {
        <a asp-controller="Likes" asp-action="UserLikes" class="btn btn-outline-danger">My Liked Posts ❤️</a>
    }
</div>

<!-- Search Form (Added per Course 10 techniques) -->
<form method="GET" action="@(showingAllPosts ? "/Posts/Index" : "/Posts/MyPosts")">
    <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Search in titles, content or comments..." name="search" value="@ViewBag.SearchString">
        <button class="btn btn-outline-primary" type="submit">Search</button>
        @if (!string.IsNullOrEmpty(ViewBag.SearchString as string))
        {
            <a href="@(showingAllPosts ? "/Posts/Index" : "/Posts/MyPosts")" class="btn btn-outline-danger">Clear</a>
        }
    </div>
</form>

<div class="row">
    @foreach (var post in Model)
    {
        <partial name="_PostCard" model="post" />
    }
</div>

<!-- Pagination Controls (Added per Course 10 techniques) -->
@if (ViewBag.LastPage > 1)
{
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="@(ViewBag.PaginationBaseUrl)@(ViewBag.CurrentPage - 1)" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            @for (int i = 1; i <= ViewBag.LastPage; i++)
            {
                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                    <a class="page-link" href="@(ViewBag.PaginationBaseUrl)@i">@i</a>
                </li>
            }
            <li class="page-item @(ViewBag.CurrentPage == ViewBag.LastPage ? "disabled" : "")">
                <a class="page-link" href="@(ViewBag.PaginationBaseUrl)@(ViewBag.CurrentPage + 1)" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
}

@if (!Model.Any())
{
    <div class="alert alert-info text-center">
        @if (showingAllPosts)
        {
            <h4>No posts available yet.</h4>
            <p>Be the first to create a post!</p>
        }
        else
        {
            <h4>You haven't created any posts yet.</h4>
            <p><a asp-action="Create" class="btn btn-primary">Create your first post!</a></p>
        }
    </div>
}

@section Scripts {
    <script>
        // Load like status and comment counts for all posts when page loads
        $(document).ready(function() {
            @if (User.Identity?.IsAuthenticated == true)
            {
                <text>
                $('.like-section').each(function() {
                    var postId = $(this).data('post-id');
                    loadLikeStatus(postId);
                });
                </text>
            }
            else
            {
                <text>
                // Load like count for non-authenticated users
                $('.like-section').each(function() {
                    var postId = $(this).data('post-id');
                    loadLikeCount(postId);
                });
                </text>
            }

            // Load comment counts for all posts
            $('.comment-section').each(function() {
                var postId = $(this).data('post-id');
                loadCommentCount(postId);
            });
        });

        // Handle like button clicks
        $(document).on('click', '.like-btn', function() {
            var postId = $(this).data('post-id');
            toggleLike(postId);
        });

        function loadLikeStatus(postId) {
            $.get('/Likes/GetLikeStatus', { postId: postId })
                .done(function(data) {
                    if (data.success) {
                        updateLikeButton(postId, data.isLiked, data.likeCount);
                    }
                });
        }

        function loadLikeCount(postId) {
            $.get('/Likes/GetLikeStatus', { postId: postId })
                .done(function(data) {
                    if (data.success) {
                        $('.like-section[data-post-id="' + postId + '"] .like-count').text(data.likeCount);
                    }
                });
        }

        function loadCommentCount(postId) {
            $.get('/Comments/GetPostComments', { postId: postId })
                .done(function(data) {
                    if (data.success) {
                        $('.comment-section[data-post-id="' + postId + '"] .comment-count').text(data.comments.length);
                    }
                });
        }

        function toggleLike(postId) {
            $.post('/Likes/Toggle', { 
                postId: postId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(data) {
                if (data.success) {
                    updateLikeButton(postId, data.isLiked, data.likeCount);
                } else {
                    alert(data.message || 'Error occurred');
                }
            })
            .fail(function() {
                alert('Error occurred while processing like');
            });
        }

        function updateLikeButton(postId, isLiked, likeCount) {
            var likeBtn = $('.like-btn[data-post-id="' + postId + '"]');
            var likeIcon = likeBtn.find('.like-icon');
            var likeCountSpan = likeBtn.find('.like-count');
            
            if (isLiked) {
                likeBtn.removeClass('btn-outline-danger').addClass('btn-danger');
                likeIcon.removeClass('bi-heart').addClass('bi-heart-fill');
            } else {
                likeBtn.removeClass('btn-danger').addClass('btn-outline-danger');
                likeIcon.removeClass('bi-heart-fill').addClass('bi-heart');
            }
            
            likeCountSpan.text(likeCount);
        }
    </script>

    <!-- Add Bootstrap Icons if not already included -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
}
