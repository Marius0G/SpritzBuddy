@model SpritzBuddy.Models.Post
@using System.Security.Claims

@{
    ViewData["Title"] = "Post Details";
    var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    int? currentUserId = null;
    if (userId != null && int.TryParse(userId, out int userIdInt))
    {
        currentUserId = userIdInt;
    }
}

<div class="container mt-4">
    <!-- Post Details Card -->
    <div class="card mb-4">
        <!-- Post Images Carousel (if any) -->
        @if (Model.PostMedias != null && Model.PostMedias.Any())
        {
            var mediaList = Model.PostMedias.OrderBy(pm => pm.OrderIndex).ToList();
            
            <div id="postImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                <!-- Indicators -->
                @if (mediaList.Count > 1)
                {
                    <div class="carousel-indicators">
                        @for (int i = 0; i < mediaList.Count; i++)
                        {
                            <button type="button" 
                                    data-bs-target="#postImagesCarousel" 
                                    data-bs-slide-to="@i" 
                                    class="@(i == 0 ? "active" : "")" 
                                    aria-current="@(i == 0 ? "true" : "false")" 
                                    aria-label="Slide @(i + 1)"></button>
                        }
                    </div>
                }

                <!-- Images -->
                <div class="carousel-inner">
                    @for (int i = 0; i < mediaList.Count; i++)
                    {
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <img src="@mediaList[i].FilePath" 
                                 class="d-block w-100" 
                                 alt="Post image @(i + 1)"
                                 style="max-height: 500px; object-fit: contain; background-color: #f8f9fa;" />
                        </div>
                    }
                </div>

                <!-- Controls -->
                @if (mediaList.Count > 1)
                {
                    <button class="carousel-control-prev" type="button" data-bs-target="#postImagesCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#postImagesCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                }
            </div>
        }

        <div class="card-body">
            <h2 class="card-title">@Model.Title</h2>
            <p class="text-muted">
                By <strong>@Model.User.FirstName @Model.User.LastName</strong> on @Model.CreateDate.ToString("MMM dd, yyyy HH:mm")
            </p>
            <hr />
            <div class="card-text" style="white-space: pre-wrap;">@Model.Content</div>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    @if (currentUserId.HasValue && Model.UserId == currentUserId.Value)
                    {
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning btn-sm">Edit</a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger btn-sm">Delete</a>
                    }
                </div>
                <div>
                    <!-- Like Button -->
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <button type="button" class="btn btn-outline-danger btn-sm like-btn" id="like-btn" data-post-id="@Model.Id">
                            <i class="bi bi-heart like-icon"></i>
                            <span class="like-count">0</span> Likes
                        </button>
                    }
                    else
                    {
                        <a href="/Account/Login" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-heart"></i>
                            <span class="like-count">0</span> Likes
                        </a>
                    }

                    <a asp-controller="Comments" asp-action="PostComments" asp-route-id="@Model.Id" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="bi bi-chat-fill"></i> <span id="comment-count">0</span> Comments
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card">
        <div class="card-header">
            <h4>Comments</h4>
        </div>
        <div class="card-body">
            <!-- Add Comment Form (only for logged-in users) -->
            @if (User.Identity?.IsAuthenticated == true)
            {
                <div class="mb-4">
                    <h5>Add a Comment</h5>
                    <form id="comment-form">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <textarea id="comment-content" class="form-control" rows="3" placeholder="Write your comment here..." maxlength="1000"></textarea>
                            <small class="text-muted">Maximum 1000 characters</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Comment</button>
                    </form>
                </div>
                <hr />
            }
            else
            {
                <div class="alert alert-info">
                    <a href="/Account/Login">Log in</a> to post comments
                </div>
            }

            <!-- Comments List -->
            <div id="comments-list">
                <p class="text-center"><em>Loading comments...</em></p>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">Back to All Posts</a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load likes and comments
            loadLikeStatus();
            loadComments();
        });

        // Load like status for this post
        function loadLikeStatus() {
            @if (User.Identity?.IsAuthenticated == true)
            {
                <text>
                $.get('/Likes/GetLikeStatus', { postId: @Model.Id })
                    .done(function(data) {
                        if (data.success) {
                            updateLikeButton(data.isLiked, data.likeCount);
                        }
                    })
                    .fail(function() {
                        console.error('Error loading like status');
                    });
                </text>
            }
            else
            {
                <text>
                $.get('/Likes/GetLikeStatus', { postId: @Model.Id })
                    .done(function(data) {
                        if (data.success) {
                            $('.like-count').text(data.likeCount);
                        }
                    })
                    .fail(function() {
                        console.error('Error loading like count');
                    });
                </text>
            }
        }

        // Handle like button click
        $('#like-btn').on('click', function() {
            toggleLike();
        });

        function toggleLike() {
            $.post('/Likes/Toggle', { 
                postId: @Model.Id,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(data) {
                if (data.success) {
                    updateLikeButton(data.isLiked, data.likeCount);
                } else {
                    alert(data.message || 'Error occurred');
                }
            })
            .fail(function() {
                alert('Error occurred while processing like');
            });
        }

        function updateLikeButton(isLiked, likeCount) {
            var likeBtn = $('#like-btn');
            var likeIcon = likeBtn.find('.like-icon');
            var likeCountSpan = likeBtn.find('.like-count');
            
            if (isLiked) {
                likeBtn.removeClass('btn-outline-danger').addClass('btn-danger');
                likeIcon.removeClass('bi-heart').addClass('bi-heart-fill');
            } else {
                likeBtn.removeClass('btn-danger').addClass('btn-outline-danger');
                likeIcon.removeClass('bi-heart-fill').addClass('bi-heart');
            }
            
            likeCountSpan.text(likeCount);
        }

        // Load comments for this post
        function loadComments() {
            $.get('/Comments/GetPostComments', { postId: @Model.Id })
                .done(function(data) {
                    if (data.success) {
                        displayComments(data.comments, data.currentUserId);
                        updateCommentCount(data.comments.length);
                    }
                })
                .fail(function() {
                    $('#comments-list').html('<p class="text-danger">Error loading comments</p>');
                });
        }

        // Display comments in the list
        function displayComments(comments, currentUserId) {
            var html = '';
            
            if (comments.length === 0) {
                html = '<p class="text-muted">No comments yet. Be the first to comment!</p>';
            } else {
                comments.forEach(function(comment) {
                    html += '<div class="comment-item mb-3 p-3 border rounded" data-comment-id="' + comment.id + '">';
                    html += '  <div class="d-flex justify-content-between align-items-start">';
                    html += '    <div class="flex-grow-1">';
                    html += '      <h6 class="mb-1">' + comment.userName + '</h6>';
                    
                    // Comment content - can be in view or edit mode
                    html += '      <div class="comment-view-mode">';
                    html += '        <p class="mb-1 comment-content">' + escapeHtml(comment.content) + '</p>';
                    html += '        <small class="text-muted">' + comment.createDate + '</small>';
                    html += '      </div>';
                    
                    // Edit form (hidden by default)
                    html += '      <div class="comment-edit-mode" style="display: none;">';
                    html += '        <textarea class="form-control mb-2 edit-comment-textarea" rows="3" maxlength="1000">' + escapeHtml(comment.content) + '</textarea>';
                    html += '        <button class="btn btn-sm btn-primary save-edit-btn" onclick="saveCommentEdit(' + comment.id + ')">Save</button>';
                    html += '        <button class="btn btn-sm btn-secondary cancel-edit-btn" onclick="cancelCommentEdit(' + comment.id + ')">Cancel</button>';
                    html += '      </div>';
                    
                    html += '    </div>';
                    
                    if (currentUserId === comment.userId) {
                        html += '    <div class="btn-group comment-actions">';
                        html += '      <button class="btn btn-sm btn-outline-primary" onclick="editComment(' + comment.id + ')">Edit</button>';
                        html += '      <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(' + comment.id + ')">Delete</button>';
                        html += '    </div>';
                    }
                    
                    html += '  </div>';
                    html += '</div>';
                });
            }
            
            $('#comments-list').html(html);
        }

        // Update comment count
        function updateCommentCount(count) {
            $('#comment-count').text(count);
        }

        // Handle comment form submission
        $('#comment-form').on('submit', function(e) {
            e.preventDefault();
            
            var content = $('#comment-content').val().trim();
            
            if (content === '') {
                alert('Please enter a comment');
                return;
            }
            
            $.post('/Comments/Create', {
                postId: @Model.Id,
                content: content,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(data) {
                if (data.success) {
                    $('#comment-content').val('');
                    loadComments();
                } else {
                    alert(data.message || 'Error posting comment');
                }
            })
            .fail(function() {
                alert('Error occurred while posting comment');
            });
        });

        // Edit comment - show edit form
        function editComment(commentId) {
            var commentItem = $('.comment-item[data-comment-id="' + commentId + '"]');
            commentItem.find('.comment-view-mode').hide();
            commentItem.find('.comment-edit-mode').show();
            commentItem.find('.comment-actions').hide();
        }

        // Cancel comment edit
        function cancelCommentEdit(commentId) {
            var commentItem = $('.comment-item[data-comment-id="' + commentId + '"]');
            commentItem.find('.comment-view-mode').show();
            commentItem.find('.comment-edit-mode').hide();
            commentItem.find('.comment-actions').show();
        }

        // Save comment edit
        function saveCommentEdit(commentId) {
            var commentItem = $('.comment-item[data-comment-id="' + commentId + '"]');
            var newContent = commentItem.find('.edit-comment-textarea').val().trim();
            
            if (newContent === '') {
                alert('Comment cannot be empty');
                return;
            }
            
            $.post('/Comments/Edit', {
                id: commentId,
                content: newContent,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(data) {
                if (data.success) {
                    // Update the comment content in the view
                    commentItem.find('.comment-content').text(newContent);
                    cancelCommentEdit(commentId);
                } else {
                    alert(data.message || 'Error updating comment');
                }
            })
            .fail(function() {
                alert('Error occurred while updating comment');
            });
        }

        // Delete comment
        function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            $.post('/Comments/Delete', {
                id: commentId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            })
            .done(function(data) {
                if (data.success) {
                    loadComments();
                } else {
                    alert(data.message || 'Error deleting comment');
                }
            })
            .fail(function() {
                alert('Error occurred while deleting comment');
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>

    <!-- Add Bootstrap Icons if not already included -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
}
