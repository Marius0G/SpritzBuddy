@model SpritzBuddy.Models.ViewModels.ProfileViewModel

@{
 ViewData["Title"] = "Profil";
}

<div class="container py-4">
 <div class="row">
 <div class="col-md-4">
 <div class="card">
 <div class="card-body text-center">
 @if (!string.IsNullOrEmpty(Model.ProfilePicturePath))
 {
 <img src="@Model.ProfilePicturePath" class="rounded-circle img-thumbnail mb-3" style="width:160px;height:160px;object-fit:cover;" alt="Profile" />
 }
 else
 {
 <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mb-3 mx-auto" style="width:160px;height:160px;font-size:3rem;">@((Model.FirstName ?? "")[0])</div>
 }

 <h4>@Model.FirstName @Model.LastName</h4>
 <p class="text-muted">@Model.Description</p>

 @if (Model.IsCurrentUser)
 {
 <div class="mb-3">
 <a asp-controller="Profile" asp-action="Edit" class="btn btn-outline-primary btn-sm">
 <i class="bi bi-pencil"></i> Edit Profile
 </a>
 <a asp-controller="Posts" asp-action="Create" class="btn btn-primary btn-sm">
 <i class="bi bi-plus-square"></i> Create Post
 </a>
 </div>
 }
 else if (User.Identity?.IsAuthenticated == true)
 {
 <div class="mb-3">
 @if (Model.IsFollowing)
 {
 <form asp-controller="Follows" asp-action="Unfollow" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-danger btn-sm">
 <i class="bi bi-person-dash"></i> Unfollow
 </button>
 </form>
 }
 else if (Model.HasPendingRequest)
 {
 <span class="badge bg-warning text-dark me-2">Request Sent</span>
 <form asp-controller="Follows" asp-action="Unfollow" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-outline-secondary btn-sm">
 <i class="bi bi-x-circle"></i> Cancel Request
 </button>
 </form>
 }
 else
 {
 <form asp-controller="Follows" asp-action="SendRequest" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-primary btn-sm">
 <i class="bi bi-person-plus"></i> @(Model.IsPrivate ? "Request Follow" : "Follow")
 </button>
 </form>
 }
 </div>
 }

 <div class="d-flex justify-content-around mt-3">
 <div class="text-center">
 <strong>@Model.PostCount</strong>
 <div class="text-muted">Posts</div>
 </div>
 <div class="text-center">
 <strong>@Model.FollowersCount</strong>
 <div class="text-muted">Followers</div>
 </div>
 <div class="text-center">
 <strong>@Model.FollowingCount</strong>
 <div class="text-muted">Following</div>
 </div>
 </div>
 </div>
 </div>
 </div>

 <div class="col-md-8">
 @if (Model.IsCurrentUser)
 {
 <!-- Tabs for current user profile -->
 <ul class="nav nav-tabs mb-3" id="profileTabs" role="tablist">
 <li class="nav-item" role="presentation">
 <button class="nav-link active" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
 <i class="bi bi-bar-chart"></i> Stats & Badges
 </button>
 </li>
 <li class="nav-item" role="presentation">
 <button class="nav-link position-relative" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
 <i class="bi bi-bell"></i> Notifications
 <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifications-tab-badge" style="display: none;">
 0
 </span>
 </button>
 </li>
 </ul>

 <div class="tab-content" id="profileTabsContent">
 <!-- Stats & Badges Tab -->
 <div class="tab-pane fade show active" id="stats" role="tabpanel">
 <div class="card mb-3">
 <div class="card-body">
 <h5>Badges</h5>
 @if (Model.Badges != null && Model.Badges.Count >0)
 {
 <div>
 @foreach (var badge in Model.Badges)
 {
 <span class="badge bg-primary me-1">@badge</span>
 }
 </div>
 }
 else
 {
 <p class="text-muted">No badges yet.</p>
 }
 </div>
 </div>

 <div class="card">
 <div class="card-body">
 <h5>Spritz-o-meter</h5>
 @if (Model.DrinkStats != null && Model.DrinkStats.Count >0)
 {
 <!-- GitHub-style horizontal bar -->
 <div class="mb-3" style="display: flex; height: 22px; border-radius: 8px; overflow: hidden;">
 @foreach (var drink in Model.DrinkStats)
 {
 <div style="width: @drink.Percentage%; background-color: @drink.ColorHex;" title="@drink.DrinkName: @string.Format("{0:0.0}%", drink.Percentage)"></div>
 }
 </div>
 <!-- Legend with drink names and percentages -->
 <div class="drink-stats-legend">
 @foreach (var drink in Model.DrinkStats)
 {
 <div class="d-flex align-items-center mb-2">
 <span class="drink-color-dot" style="background-color: @drink.ColorHex;"></span>
 <span class="drink-name me-2">@drink.DrinkName</span>
 <span class="drink-percentage text-muted">@string.Format("{0:0.0}%", drink.Percentage)</span>
 </div>
 }
 </div>
 }
 else
 {
 <p class="text-muted">Nu ai băut nimic încă!</p>
 }
 </div>
 </div>
 </div>

 <!-- Notifications Tab -->
 <div class="tab-pane fade" id="notifications" role="tabpanel">
 <div id="notifications-container">
 <p class="text-center"><i class="bi bi-hourglass-split"></i> Loading notifications...</p>
 </div>
 </div>
 </div>
 }
 else
 {
 <!-- Non-current user profile - show stats only -->
 <div class="card mb-3">
 <div class="card-body">
 <h5>Badges</h5>
 @if (Model.Badges != null && Model.Badges.Count >0)
 {
 <div>
 @foreach (var badge in Model.Badges)
 {
 <span class="badge bg-primary me-1">@badge</span>
 }
 </div>
 }
 else
 {
 <p class="text-muted">No badges yet.</p>
 }
 </div>
 </div>

 <div class="card">
 <div class="card-body">
 <h5>Spritz-o-meter</h5>
 @if (Model.DrinkStats != null && Model.DrinkStats.Count >0)
 {
 <!-- GitHub-style horizontal bar -->
 <div class="mb-3" style="display: flex; height: 22px; border-radius: 8px; overflow: hidden;">
 @foreach (var drink in Model.DrinkStats)
 {
 <div style="width: @drink.Percentage%; background-color: @drink.ColorHex;" title="@drink.DrinkName: @string.Format("{0:0.0}%", drink.Percentage)"></div>
 }
 </div>
 <!-- Legend with drink names and percentages -->
 <div class="drink-stats-legend">
 @foreach (var drink in Model.DrinkStats)
 {
 <div class="d-flex align-items-center mb-2">
 <span class="drink-color-dot" style="background-color: @drink.ColorHex;"></span>
 <span class="drink-name me-2">@drink.DrinkName</span>
 <span class="drink-percentage text-muted">@string.Format("{0:0.0}%", drink.Percentage)</span>
 </div>
 }
 </div>
 }
 else
 {
 <p class="text-muted">Nu ai băut nimic încă!</p>
 }
 </div>
 </div>
 }
 </div>
 </div>
</div>

<!-- Posts Grid (Instagram Style) -->
@if (Model.Posts != null && Model.Posts.Any())
{
 <div class="container py-4">
 <hr class="mb-4" />
 <h5 class="mb-4"><i class="bi bi-grid-3x3"></i> Posts</h5>
 <div class="row g-2">
 @foreach (var post in Model.Posts)
 {
 <div class="col-md-4 col-sm-6 col-4">
 <a href="@Url.Action("PostComments", "Comments", new { id = post.Id })" class="text-decoration-none">
 <div class="profile-post-item">
 @if (post.PostMedias != null && post.PostMedias.Any())
 {
 var firstMedia = post.PostMedias.First();
 <img src="@firstMedia.FilePath" class="profile-post-img" alt="Post" />
 }
 else
 {
 <div class="profile-post-text">
 <p>@(post.Content.Length > 100 ? post.Content.Substring(0, 100) + "..." : post.Content)</p>
 </div>
 }
 <div class="profile-post-overlay">
 <div class="profile-post-stats">
 <span class="me-3">
 <i class="bi bi-cup-straw"></i> @post.Likes.Count
 </span>
 <span>
 <i class="bi bi-chat"></i> @post.Comments.Count
 </span>
 </div>
 </div>
 </div>
 </a>
 </div>
 }
 </div>
 </div>
}
else if (Model.IsCurrentUser)
{
 <div class="container py-4 text-center">
 <hr class="mb-4" />
 <i class="bi bi-camera" style="font-size: 3rem; color: #ccc;"></i>
 <p class="text-muted mt-3">No posts yet</p>
 <a asp-controller="Posts" asp-action="Create" class="btn btn-primary">Create your first post</a>
 </div>
}

<style>
    .drink-color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .drink-name {
        font-size: 1.05rem;
        font-weight: 600;
        flex: 1;
    }
    .drink-percentage {
        font-size: 1rem;
        font-weight: 600;
        margin-left: auto;
    }
    .drink-stats-legend {
        font-size: 1rem;
        font-weight: 600;
    }
    
    /* Instagram-style post grid */
    .profile-post-item {
        position: relative;
        width: 100%;
        padding-bottom: 100%; /* 1:1 Aspect Ratio */
        overflow: hidden;
        background: #fafafa;
        border-radius: 4px;
    }
    
    .profile-post-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .profile-post-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
        color: #333;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .profile-post-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .profile-post-item:hover .profile-post-overlay {
        opacity: 1;
    }
    
    .profile-post-stats {
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
    }
</style>

@if (Model.IsCurrentUser)
{
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        loadNotifications();
        updateNotificationBadge();
        
        // Refresh every 30 seconds
        setInterval(function() {
            loadNotifications();
            updateNotificationBadge();
        }, 30000);
    });

    function updateNotificationBadge() {
        $.get('/Notifications/GetNotificationCount')
            .done(function(data) {
                if (data.count > 0) {
                    $('#notifications-tab-badge').text(data.count).show();
                } else {
                    $('#notifications-tab-badge').hide();
                }
            });
    }

    function loadNotifications() {
        $.get('/Notifications/GetNotificationsHtml')
            .done(function(html) {
                $('#notifications-container').html(html);
            })
            .fail(function() {
                $('#notifications-container').html('<div class="alert alert-danger">Failed to load notifications.</div>');
            });
    }
</script>
}
