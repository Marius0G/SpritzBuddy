@model SpritzBuddy.Models.ViewModels.ProfileViewModel

@{
 ViewData["Title"] = "Profil";
 var pendingFollowRequests = ViewBag.PendingFollowRequests as List<SpritzBuddy.Models.Follow> ?? new List<SpritzBuddy.Models.Follow>();
 var pendingGroupRequests = ViewBag.PendingGroupRequests as List<SpritzBuddy.Models.UserGroup> ?? new List<SpritzBuddy.Models.UserGroup>();
 var upcomingEvents = ViewBag.UpcomingEvents as List<SpritzBuddy.Models.Event> ?? new List<SpritzBuddy.Models.Event>();
 var hasNotifications = pendingFollowRequests.Any() || pendingGroupRequests.Any() || upcomingEvents.Any();
}

@if (Model.IsCurrentUser && hasNotifications)
{
    <div class="container py-3">
        <div class="alert alert-warning shadow-sm" style="border-left: 4px solid var(--beer-amber, #C68E17);">
            <h5 class="alert-heading">
                <i class="bi bi-bell-fill"></i> Notificări
                <span class="badge bg-danger ms-2">@(pendingFollowRequests.Count + pendingGroupRequests.Count + upcomingEvents.Count)</span>
            </h5>
            <hr>
            
            @if (upcomingEvents.Any())
            {
                <div class="mb-3">
                    <h6><i class="bi bi-calendar-event"></i> Evenimente viitoare (@upcomingEvents.Count)</h6>
                    <div class="list-group">
                        @foreach (var evt in upcomingEvents)
                        {
                            <a href="@Url.Action("Details", "Events", new { id = evt.Id })" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@evt.Title</strong>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3"></i> @evt.EventDate.ToString("dd MMM yyyy, HH:mm")
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="ms-2"><i class="bi bi-geo-alt"></i> @evt.Location</span>
                                        }
                                    </small>
                                </div>
                                <span class="badge bg-success">Confirmat</span>
                            </a>
                        }
                    </div>
                </div>
            }
            
            @if (pendingFollowRequests.Any())
            {
                <div class="mb-3">
                    <h6><i class="bi bi-person-plus"></i> Cereri de urmărire (@pendingFollowRequests.Count)</h6>
                    <div class="list-group">
                        @foreach (var request in pendingFollowRequests)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(request.Follower.ProfilePictureUrl))
                                    {
                                        <img src="@request.Follower.ProfilePictureUrl" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                            @((request.Follower.FirstName ?? "U")[0])
                                        </div>
                                    }
                                    <strong>@request.Follower.UserName</strong>
                                </div>
                                <div>
                                    <form asp-controller="Follows" asp-action="Accept" method="post" class="d-inline">
                                        <input type="hidden" name="followerId" value="@request.FollowerId" />
                                        <button type="submit" class="btn btn-success btn-sm">Acceptă</button>
                                    </form>
                                    <form asp-controller="Follows" asp-action="Decline" method="post" class="d-inline">
                                        <input type="hidden" name="followerId" value="@request.FollowerId" />
                                        <button type="submit" class="btn btn-danger btn-sm">Refuză</button>
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            
            @if (pendingGroupRequests.Any())
            {
                <div class="mb-3">
                    <h6><i class="bi bi-people"></i> Cereri de intrare în grupuri (@pendingGroupRequests.Count)</h6>
                    <div class="list-group">
                        @foreach (var request in pendingGroupRequests)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>@request.User.UserName</strong> → <em>@request.Group.Name</em>
                                </div>
                                <div>
                                    <form asp-controller="Groups" asp-action="Accept" method="post" class="d-inline">
                                        <input type="hidden" name="groupId" value="@request.GroupId" />
                                        <input type="hidden" name="userId" value="@request.UserId" />
                                        <button type="submit" class="btn btn-success btn-sm">Acceptă</button>
                                    </form>
                                    <form asp-controller="Groups" asp-action="Decline" method="post" class="d-inline">
                                        <input type="hidden" name="groupId" value="@request.GroupId" />
                                        <input type="hidden" name="userId" value="@request.UserId" />
                                        <button type="submit" class="btn btn-danger btn-sm">Refuză</button>
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

<div class="container py-4">
 <div class="row">
 <div class="col-md-4">
 <div class="card">
 <div class="card-body text-center">
 @if (!string.IsNullOrEmpty(Model.ProfilePicturePath))
 {
 <img src="@Model.ProfilePicturePath" class="rounded-circle img-thumbnail mb-3" style="width:160px;height:160px;object-fit:cover;" alt="Profile" />
 }
 else
 {
 <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mb-3" style="width:160px;height:160px;">@((Model.FirstName ?? "")[0])</div>
 }

 <h4>@Model.FirstName @Model.LastName</h4>
 <p class="text-muted">@Model.Description</p>

 @if (Model.IsCurrentUser)
 {
 <div class="mb-3">
 <a asp-controller="Profile" asp-action="Edit" class="btn btn-outline-primary btn-sm w-100 mb-2">
     <i class="bi bi-pencil"></i> Editează profil
 </a>
 <a asp-controller="Posts" asp-action="Create" class="btn btn-primary btn-sm w-100">
     <i class="bi bi-plus-circle"></i> Postare Nouă
 </a>
 </div>
 }
 else if (User.Identity?.IsAuthenticated == true)
 {
 <div class="mb-3">
 @if (Model.IsFollowing)
 {
 <form asp-controller="Follows" asp-action="Unfollow" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-danger btn-sm">
 <i class="bi bi-person-dash"></i> Unfollow
 </button>
 </form>
 }
 else if (Model.HasPendingRequest)
 {
 <span class="badge bg-warning text-dark me-2">Request Sent</span>
 <form asp-controller="Follows" asp-action="Unfollow" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-outline-secondary btn-sm">
 <i class="bi bi-x-circle"></i> Cancel Request
 </button>
 </form>
 }
 else
 {
 <form asp-controller="Follows" asp-action="SendRequest" method="post" class="d-inline">
 <input type="hidden" name="followingId" value="@Model.UserId" />
 <button type="submit" class="btn btn-primary btn-sm">
 <i class="bi bi-person-plus"></i> @(Model.IsPrivate ? "Request Follow" : "Follow")
 </button>
 </form>
 }
 </div>
 }

 <div class="d-flex justify-content-around mt-3">
 <div class="text-center">
 <strong>@Model.PostCount</strong>
 <div class="text-muted">Posts</div>
 </div>
 <div class="text-center">
 <strong>@Model.FollowersCount</strong>
 <div class="text-muted">Followers</div>
 </div>
 <div class="text-center">
 <strong>@Model.FollowingCount</strong>
 <div class="text-muted">Following</div>
 </div>
 </div>
 </div>
 </div>
 </div>

 <div class="col-md-8">
 <div class="card mb-3">
 <div class="card-body">
                             <h5>Badges</h5>
                             <div class="d-flex flex-wrap gap-2 mb-3">
                                 @if (Model.Badges != null && Model.Badges.Any())
                                 {
                                     foreach (var badge in Model.Badges)
                                     {
                                         if (Model.IsCurrentUser || badge.IsUnlocked)
                                         {
                                             var opacityClass = badge.IsUnlocked ? "" : "opacity-50 grayscale";
                                             var titleAttr = badge.IsUnlocked ? badge.Name : $"{badge.Name}: {badge.Description}";
                                             
                                             <div class="text-center p-2 border rounded @opacityClass" title="@titleAttr" style="width: 80px;" data-bs-toggle="tooltip" data-bs-placement="top">
                                                 <i class="bi @badge.IconClass fs-2 @badge.ColorClass"></i>
                                                 <div class="text-truncate" style="font-size: 0.7rem; margin-top: 5px;">@badge.Name</div>
                                             </div>
                                         }
                                     }
                                 }
                                 else
                                 {
                                     <p class="text-muted">No badges system loaded.</p>
                                 }
                             </div>
                         </div>
                     </div>
 
                     <div class="card">
                         <div class="card-body">
                             <h5>Spritz-o-meter</h5> @if (Model.DrinkStats != null && Model.DrinkStats.Count >0)
 {
 <!-- GitHub-style horizontal bar -->
 <div class="mb-3" style="display: flex; height: 22px; border-radius: 8px; overflow: hidden;">
 @foreach (var drink in Model.DrinkStats)
 {
 <div style="width: @drink.Percentage%; background-color: @drink.ColorHex;" title="@drink.DrinkName: @string.Format("{0:0.0}%", drink.Percentage)"></div>
 }
 </div>
 <!-- Legend with drink names and percentages -->
 <div class="drink-stats-legend">
 @foreach (var drink in Model.DrinkStats)
 {
 <div class="d-flex align-items-center mb-2">
 <span class="drink-color-dot" style="background-color: @drink.ColorHex;"></span>
 <span class="drink-name me-2">@drink.DrinkName</span>
 <span class="drink-percentage text-muted">@string.Format("{0:0.0}%", drink.Percentage)</span>
 </div>
 }
 </div>
 }
 else
 {
 <p class="text-muted">Nu ai băut nimic încă!</p>
 }
 </div>
 </div>
 </div>
 </div>
</div>

<!-- Posts Grid (Instagram Style) -->
@if (Model.Posts != null && Model.Posts.Any())
{
 <div class="container py-4">
 <hr class="mb-4" />
 <h5 class="mb-4"><i class="bi bi-grid-3x3"></i> Posts</h5>
 <div class="row g-2">
 @foreach (var post in Model.Posts)
 {
 <div class="col-md-4 col-sm-6 col-4">
 <a href="@Url.Action("PostComments", "Comments", new { id = post.Id })" class="text-decoration-none">
 <div class="profile-post-item">
 @if (post.PostMedias != null && post.PostMedias.Any())
 {
 var firstMedia = post.PostMedias.First();
 <img src="@firstMedia.FilePath" class="profile-post-img" alt="Post" />
 }
 else
 {
 <div class="profile-post-text">
 <p>@(post.Content.Length > 100 ? post.Content.Substring(0, 100) + "..." : post.Content)</p>
 </div>
 }
 <div class="profile-post-overlay">
 <div class="profile-post-stats">
 <span class="me-3">
 <i class="bi bi-cup-straw"></i> @post.Likes.Count
 </span>
 <span>
 <i class="bi bi-chat"></i> @post.Comments.Count
 </span>
 </div>
 </div>
 </div>
 </a>
 </div>
 }
 </div>
 </div>
}
else if (Model.IsCurrentUser)
{
 <div class="container py-4 text-center">
 <hr class="mb-4" />
 <i class="bi bi-camera" style="font-size: 3rem; color: #ccc;"></i>
 <p class="text-muted mt-3">No posts yet</p>
 <a asp-controller="Posts" asp-action="Create" class="btn btn-primary">Create your first post</a>
 </div>
}

<style>
    .drink-color-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .grayscale {
        filter: grayscale(100%);
    }
    .drink-name {
        font-size: 1.05rem;
        font-weight: 600;
        flex: 1;
    }
    .drink-percentage {
        font-size: 1rem;
        font-weight: 600;
        margin-left: auto;
    }
    .drink-stats-legend {
        font-size: 1rem;
        font-weight: 600;
    }
    
    /* Instagram-style post grid */
    .profile-post-item {
        position: relative;
        width: 100%;
        padding-bottom: 100%; /* 1:1 Aspect Ratio */
        overflow: hidden;
        background: #fafafa;
        border-radius: 4px;
    }
    
    .profile-post-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .profile-post-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
        color: #333;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    .profile-post-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .profile-post-item:hover .profile-post-overlay {
        opacity: 1;
    }
    
    .profile-post-stats {
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
    }
</style>
