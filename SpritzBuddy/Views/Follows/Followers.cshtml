@model IEnumerable<SpritzBuddy.Models.Follow>

@{
    ViewData["Title"] = "Followers";
    var targetUser = ViewBag.TargetUser as SpritzBuddy.Models.ApplicationUser;
    var isOwnProfile = ViewBag.IsOwnProfile as bool? ?? false;
}

<div class="container mt-4">
    <h2>
        @if (isOwnProfile)
        {
            <text>Your Followers</text>
        }
        else if (targetUser != null)
        {
            <text>@targetUser.FirstName's Followers</text>
        }
        else
        {
            <text>Followers</text>
        }
    </h2>
    <p class="text-muted">@Model.Count() @(Model.Count() == 1 ? "follower" : "followers")</p>

    @if (Model.Any())
    {
        <div class="row">
            @foreach (var follow in Model)
            {
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card follower-item" data-follower-id="@follow.FollowerId">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <!-- Profile Picture -->
                                @if (!string.IsNullOrEmpty(follow.Follower.ProfilePictureUrl))
                                {
                                    <img src="@follow.Follower.ProfilePictureUrl" 
                                         class="rounded-circle me-3" 
                                         alt="Profile" 
                                         style="width: 60px; height: 60px; object-fit: cover;" />
                                }
                                else
                                {
                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3"
                                         style="width: 60px; height: 60px;">
                                        <span class="fw-bold fs-4">@follow.Follower.FirstName.Substring(0, 1)@follow.Follower.LastName.Substring(0, 1)</span>
                                    </div>
                                }

                                <!-- User Info -->
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">
                                        <a asp-controller="Profile" asp-action="Index" asp-route-username="@follow.Follower.UserName">
                                            @follow.Follower.FirstName @follow.Follower.LastName
                                        </a>
                                    </h6>
                                    <small class="text-muted">@("@" + follow.Follower.UserName)</small>
                                    @if (!string.IsNullOrEmpty(follow.Follower.Description))
                                    {
                                        <p class="mb-0 mt-1 text-muted small">
                                            @(follow.Follower.Description.Length > 50 ? follow.Follower.Description.Substring(0, 50) + "..." : follow.Follower.Description)
                                        </p>
                                    }
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Following since @follow.RequestDate.ToString("MMM yyyy")</small>
                                @if (isOwnProfile)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-follower-btn" data-follower-id="@follow.FollowerId">
                                        Remove
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-people" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No followers yet</h4>
            @if (isOwnProfile)
            {
                <p>When people follow you, they'll appear here.</p>
            }
            else
            {
                <p>This user doesn't have any followers yet.</p>
            }
        </div>
    }

    <div class="mt-4">
        @if (isOwnProfile)
        {
            <a asp-action="Requests" class="btn btn-primary">View Requests</a>
            <a asp-action="Following" class="btn btn-secondary">View Following</a>
        }
        else if (targetUser != null)
        {
            <a asp-controller="Profile" asp-action="Index" asp-route-username="@targetUser.UserName" class="btn btn-secondary">Back to Profile</a>
        }
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Home</a>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    
    @if (isOwnProfile)
    {
        <script>
            $(document).ready(function() {
                $('.remove-follower-btn').on('click', function() {
                    if (!confirm('Are you sure you want to remove this follower?')) {
                        return;
                    }
                    var followerId = $(this).data('follower-id');
                    removeFollower(followerId);
                });
            });

            function removeFollower(followerId) {
                $.post('/Follows/RemoveFollower', {
                    followerId: followerId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                })
                .done(function(data) {
                    if (data.success) {
                        $('.follower-item[data-follower-id="' + followerId + '"]').fadeOut('slow', function() {
                            $(this).remove();
                            
                            if ($('.follower-item').length === 0) {
                                location.reload();
                            }
                        });
                        showSuccessMessage(data.message || 'Follower removed');
                    } else {
                        alert(data.message || 'Error removing follower');
                    }
                })
                .fail(function() {
                    alert('Error occurred while removing follower');
                });
            }

            function showSuccessMessage(message) {
                var alertHtml = '<div class="alert alert-success alert-dismissible fade show mt-3" role="alert">' +
                                message +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                                '</div>';
                
                $('h2').after(alertHtml);
                
                setTimeout(function() {
                    $('.alert-success').fadeOut('slow', function() {
                        $(this).remove();
                    });
                }, 3000);
            }
        </script>
    }

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
}
