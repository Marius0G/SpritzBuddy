@model SpritzBuddy.Models.GroupEvent
@{
    ViewData["Title"] = "Event Details";
    var currentUserId = ViewBag.CurrentUserId;
    var userResponse = Model.Participants?.FirstOrDefault(p => p.UserId == currentUserId);
    var isCreator = Model.CreatorId == currentUserId;
    var isModerator = Model.Group.ModeratorId == currentUserId;
    var isUpcoming = Model.EventDate > DateTime.Now;
}

<div class="container mt-4">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header @(isUpcoming ? "bg-primary text-white" : "bg-secondary text-white")">
                    <h3 class="mb-0"><i class="bi bi-calendar-event-fill"></i> @Model.Title</h3>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5 class="fw-bold">Descriere</h5>
                        <p style="white-space: pre-wrap;">@Model.Description</p>
                    </div>

                    <div class="mb-3">
                        <h5 class="fw-bold"><i class="bi bi-clock-fill text-primary"></i> Dat? ?i Or?</h5>
                        <p class="lead">@Model.EventDate.ToString("dddd, dd MMMM yyyy, HH:mm")</p>
                        @if (isUpcoming)
                        {
                            var timeUntil = Model.EventDate - DateTime.Now;
                            <p class="text-muted">
                                <i class="bi bi-hourglass-split"></i> 
                                @if (timeUntil.TotalDays >= 1)
                                {
                                    <text>în @((int)timeUntil.TotalDays) zile</text>
                                }
                                else if (timeUntil.TotalHours >= 1)
                                {
                                    <text>în @((int)timeUntil.TotalHours) ore</text>
                                }
                                else
                                {
                                    <text>în curând!</text>
                                }
                            </p>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Eveniment trecut</span>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Location))
                    {
                        <div class="mb-3">
                            <h5 class="fw-bold"><i class="bi bi-geo-alt-fill text-danger"></i> Loca?ie</h5>
                            <p>@Model.Location</p>
                        </div>
                    }

                    <div class="mb-3">
                        <h5 class="fw-bold"><i class="bi bi-person-fill text-info"></i> Organizator</h5>
                        <p>@Model.Creator?.FirstName @Model.Creator?.LastName (@@@Model.Creator?.UserName)</p>
                    </div>

                    <div class="mb-3">
                        <h5 class="fw-bold"><i class="bi bi-people-fill"></i> Grup</h5>
                        <p>
                            <a asp-controller="Groups" asp-action="Details" asp-route-id="@Model.GroupId" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-right-circle"></i> @Model.Group?.Name
                            </a>
                        </p>
                    </div>

                    <hr />

                    <div class="mb-4">
                        <h5 class="fw-bold">R?spunsul t?u</h5>
                        @if (userResponse != null)
                        {
                            <p class="mb-2">
                                Status curent: 
                                @switch (userResponse.Status)
                                {
                                    case EventParticipationStatus.Going:
                                        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Vin</span>
                                        break;
                                    case EventParticipationStatus.Maybe:
                                        <span class="badge bg-warning"><i class="bi bi-question-circle"></i> Poate</span>
                                        break;
                                    case EventParticipationStatus.NotGoing:
                                        <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Nu vin</span>
                                        break;
                                }
                            </p>
                        }
                        
                        <form asp-controller="Events" asp-action="Respond" method="post" id="respond-form" class="d-flex gap-2 flex-wrap">
                            <input type="hidden" name="eventId" value="@Model.Id" />
                            <button type="button" data-status="Going" class="btn @(userResponse?.Status == EventParticipationStatus.Going ? "btn-success" : "btn-outline-success") respond-btn">
                                <i class="bi bi-check-circle"></i> Vin
                            </button>
                            <button type="button" data-status="Maybe" class="btn @(userResponse?.Status == EventParticipationStatus.Maybe ? "btn-warning" : "btn-outline-warning") respond-btn">
                                <i class="bi bi-question-circle"></i> Poate
                            </button>
                            <button type="button" data-status="NotGoing" class="btn @(userResponse?.Status == EventParticipationStatus.NotGoing ? "btn-danger" : "btn-outline-danger") respond-btn">
                                <i class="bi bi-x-circle"></i> Nu vin
                            </button>
                        </form>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a asp-controller="Groups" asp-action="Details" asp-route-id="@Model.GroupId" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Înapoi la Grup
                        </a>
                        @if (isCreator || isModerator)
                        {
                            <form asp-controller="Events" asp-action="Delete" method="post" onsubmit="return confirm('Sigur vrei s? ?tergi acest eveniment?');">
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> ?terge Eveniment
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-people-fill"></i> Participan?i</h5>
                </div>
                <div class="card-body">
                    @{
                        var going = Model.Participants?.Where(p => p.Status == EventParticipationStatus.Going).ToList() ?? new List<GroupEventParticipant>();
                        var maybe = Model.Participants?.Where(p => p.Status == EventParticipationStatus.Maybe).ToList() ?? new List<GroupEventParticipant>();
                        var notGoing = Model.Participants?.Where(p => p.Status == EventParticipationStatus.NotGoing).ToList() ?? new List<GroupEventParticipant>();
                    }

                    <div class="mb-3">
                        <h6 class="fw-bold text-success">
                            <i class="bi bi-check-circle-fill"></i> Vin (@going.Count)
                        </h6>
                        @if (going.Any())
                        {
                            <ul class="list-unstyled ms-3">
                                @foreach (var p in going)
                                {
                                    <li><i class="bi bi-person"></i> @p.User?.UserName</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted ms-3"><small>Nimeni înc?</small></p>
                        }
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-bold text-warning">
                            <i class="bi bi-question-circle-fill"></i> Poate (@maybe.Count)
                        </h6>
                        @if (maybe.Any())
                        {
                            <ul class="list-unstyled ms-3">
                                @foreach (var p in maybe)
                                {
                                    <li><i class="bi bi-person"></i> @p.User?.UserName</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted ms-3"><small>Nimeni</small></p>
                        }
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-bold text-danger">
                            <i class="bi bi-x-circle-fill"></i> Nu vin (@notGoing.Count)
                        </h6>
                        @if (notGoing.Any())
                        {
                            <ul class="list-unstyled ms-3">
                                @foreach (var p in notGoing)
                                {
                                    <li><i class="bi bi-person"></i> @p.User?.UserName</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted ms-3"><small>Nimeni</small></p>
                        }
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informa?ii</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <div class="mb-2">
                            <i class="bi bi-calendar-plus"></i>
                            Creat pe @Model.CreatedDate.ToString("dd MMM yyyy")
                        </div>
                        <div>
                            <i class="bi bi-people"></i>
                            Total r?spunsuri: @(Model.Participants?.Count ?? 0)
                        </div>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.respond-btn').click(function() {
                const status = $(this).data('status');
                const eventId = @Model.Id;
                
                $.post('/Events/Respond', {
                    eventId: eventId,
                    status: status,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                })
                .done(function(data) {
                    if (data.success) {
                        // Show success message and reload page to update UI
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message || 'Eroare la înregistrarea r?spunsului');
                    }
                })
                .fail(function() {
                    alert('Eroare la înregistrarea r?spunsului');
                });
            });
        });
    </script>
}
